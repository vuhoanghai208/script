-- C·∫•u h√¨nh n√¢ng cao
getgenv().Config = {
    ["Account Hold Gem"] = "", -- Thay b·∫±ng t√™n t√†i kho·∫£n th·ª±c t·∫ø
    ["Gem"] = "50b",
    ["Time Remove"] = 5, -- ph√∫t
    ["Link Webhook"] = "",
    ["Hop sever"] = 15, -- ph√∫t
    
    -- T√πy ch·ªânh n√¢ng cao
    ["Minimum Price"] = 5000000, -- Gi√° t·ªëi thi·ªÉu (5M)
    ["Maximum Price"] = 100000000000, -- Gi√° t·ªëi ƒëa (100B)
    ["Prioritize Low RAP"] = true, -- ∆Øu ti√™n b√°n pet RAP th·∫•p tr∆∞·ªõc
    ["Debug Mode"] = true, -- Hi·ªÉn th·ªã debug th√¥ng tin
    ["Randomize Price"] = true, -- Th√™m ƒë·ªô ng·∫´u nhi√™n v√†o gi√°
    ["Random Range"] = 0.5 -- Ph·∫ßn trƒÉm ng·∫´u nhi√™n (+/- 0.5%)
}

-- C·∫•u h√¨nh chi·∫øn l∆∞·ª£c b√°n t·ª´ng lo·∫°i pet
getgenv().hugemode = {
    -- C√≥ th·ªÉ d√πng s·ªë √¢m (-5) ho·∫∑c chu·ªói ("-5%") cho gi·∫£m gi√°
    -- C√≥ th·ªÉ d√πng s·ªë d∆∞∆°ng (10) ho·∫∑c chu·ªói ("+10%") cho tƒÉng gi√°
    ["All Huges Normal"] = { strategy = "-2%", sell = true, min_price = 10000000, max_price = 1000000000 },
    ["All Huges Golden"] = { strategy = "-2%", sell = true, min_price = 20000000, max_price = 2000000000 },
    ["All Huges Rainbow"] = { strategy = "-4%", sell = true, min_price = 50000000, max_price = 5000000000 },
    ["All Huges Shiny"] = { strategy = "-6%", sell = true, min_price = 100000000, max_price = 10000000000 }
}

-- Ch·∫∑n b√°n c√°c pet Huge c·ª• th·ªÉ (th√™m t√™n pet v√†o ƒë√¢y)
getgenv().hugeBlacklist = {
    -- V√≠ d·ª•: "Huge Hacker Cat" -- Kh√¥ng b√°n Huge Hacker Cat
}

-- Danh s√°ch pet Huge ƒë∆∞·ª£c ∆∞u ti√™n b√°n tr∆∞·ªõc (th√™m t√™n pet v√†o ƒë√¢y)
getgenv().hugePriority = {
    -- V√≠ d·ª•: "Huge Miniguin" -- B√°n Huge Miniguin tr∆∞·ªõc ti√™n
}

-- C·∫•u h√¨nh t√πy ch·ªânh cho t·ª´ng pet c·ª• th·ªÉ (ghi ƒë√® c·∫•u h√¨nh chung)
getgenv().customPetPricing = {
    -- V√≠ d·ª•: ["Huge Chicken"] = { strategy = "+5%", min_price = 300000000 }
}

-- C·∫•u h√¨nh b√°n v·∫≠t ph·∫©m (kh√¥ng ph·∫£i pet)
getgenv().item = {
    ["Hype Egg 2"] = 95,
}

-- ƒê·ª£i game t·∫£i ho√†n t·∫•t
if not game:IsLoaded() then
    game.Loaded:Wait()
end

-- Khai b√°o d·ªãch v·ª• v√† th∆∞ vi·ªán
local VirtualUser = game:GetService("VirtualUser")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
-- ===== GUI HI·ªÇN TH·ªä S·ªê HUGE =====
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "HugeCountGUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Name = "Container"
frame.Size = UDim2.new(0, 200, 0, 50)
frame.Position = UDim2.new(0, 10, 0, 10)
frame.BackgroundTransparency = 0.5
frame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
frame.BorderSizePixel = 0
frame.Parent = screenGui

local label = Instance.new("TextLabel")
label.Name = "HugeCountLabel"
label.Size = UDim2.new(1, -10, 1, -10)
label.Position = UDim2.new(0, 5, 0, 5)
label.BackgroundTransparency = 1
label.Font = Enum.Font.SourceSansBold
label.TextSize = 24
label.TextColor3 = Color3.fromRGB(255, 255, 255)
label.TextXAlignment = Enum.TextXAlignment.Left
label.TextYAlignment = Enum.TextYAlignment.Center
label.Parent = frame

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local Library = ReplicatedStorage.Library
local Client = Library.Client
local RAPCmds = require(Client.RAPCmds)
local Network = require(Client.Network)
local Savemod = require(Client.Save)
local Functions = require(ReplicatedStorage.Library.Functions)
local Items = require(ReplicatedStorage.Library.Items.Types)

-- ID c√°c map v√† icon
local TRADING_PLAZA_ICON = "rbxassetid://15048276787" -- Official Trading Plaza icon
local PLACE_IDS = {
    MAIN_WORLD = 8737899170,
    PLAZA_WORLD = 16498369169,
    TRADING_PLAZA_1 = 15588442388,
    TRADING_PLAZA_2 = 15502339080
}

-- Bi·∫øn global ƒë·ªÉ theo d√µi
local totalhuge = 0
local listedItems = {}
local currentBooth = nil
local usedSlots = 0
local MAX_BOOTH_SLOTS = 25
-- Th√™m ch·ª©c nƒÉng t√≠nh to√°n th·ªùi gian listing
local listingStartTime = os.time()
-- Th√™m bi·∫øn ƒë·∫øm s·ªë l∆∞·ª£ng Huge ƒë√£ b√°n
local hugesSold = 0
local normalItemsSold = 0

-- ƒê·∫øm s·ªë pet "Huge"
local function countHugePets()
    local count = 0
    for _, v in pairs(Savemod.Get().Inventory.Pet) do
        if string.find(v.id, "Huge") then
            count = count + 1
        end
    end
    return count
end

-- C·∫≠p nh·∫≠t ƒë·∫øm Huge ƒë·ªãnh k·ª≥
spawn(function()
    while task.wait(2) do
        local count = countHugePets() or 0
        label.Text = ("Huge Pets: %d"):format(count)
    end
end)

spawn(function()
    while task.wait(10) do
        totalhuge = countHugePets()
    end
end)

-- H√†m debug gi√° ƒë·ªÉ x√°c ƒë·ªãnh v·∫•n ƒë·ªÅ
local function debugPrice(petId, originalRap, calculatedPrice, strategy, finalPrice)
    if not getgenv().Config["Debug Mode"] then return end
    
    print("===== DEBUG PRICE CALCULATION =====")
    print("Pet ID: " .. petId)
    print("Original RAP: " .. originalRap)
    print("Strategy: " .. strategy)
    print("Calculated Price: " .. calculatedPrice)
    if finalPrice ~= calculatedPrice then
        print("Final Price (after min/max): " .. finalPrice)
    end
    print("Discount Amount: " .. (originalRap - finalPrice))
    print("Discount Percentage: " .. string.format("%.2f%%", 100 * (1 - finalPrice/originalRap)))
    print("==================================")
end

local function getElapsedTimeString()
    local elapsedSeconds = os.time() - listingStartTime
    local hours = math.floor(elapsedSeconds / 3600)
    local minutes = math.floor((elapsedSeconds % 3600) / 60)
    local seconds = elapsedSeconds % 60
    return string.format("%02d:%02d:%02d", hours, minutes, seconds)
end

-- Ch·ªëng idle
for _, v in pairs(getconnections(LocalPlayer.Idled)) do v:Disable() end
LocalPlayer.Idled:Connect(function()
    VirtualUser:ClickButton2(Vector2.new(math.random(0, 1000), math.random(0, 1000)))
end)

-- Hook ƒë·ªÉ ch·ªëng server closing ho·∫∑c idle tracking
local old
old = hookmetamethod(game, "__namecall", function(self, ...)
    local method = getnamecallmethod()
    if not checkcaller() then
        local Name = tostring(self)
        if table.find({"Server Closing", "Idle Tracking: Update Timer", "Move Server"}, Name) then
            return nil
        end
    end
    return old(self, ...)
end)
Network.Fire("Idle Tracking: Stop Timer")

-- ƒê·ª£i giao di·ªán v√† leaderstats s·∫µn s√†ng
local function waitForGameReady()
    local success, result = pcall(function()
        -- ƒê·ª£i UI v√† leaderstats
        while not (game:IsLoaded() and
               LocalPlayer:FindFirstChild("PlayerGui") and
               not LocalPlayer.PlayerGui:FindFirstChild("__INTRO") and
               LocalPlayer.PlayerGui:FindFirstChild("MainLeft") and
               LocalPlayer.PlayerGui.MainLeft.Left.Currency.Diamonds.Diamonds.Visible == true and
               not LocalPlayer:FindFirstChild("GUIFX Holder")) do
            task.wait(0.5)
        end
        
        -- ƒê·ª£i leaderstats
        local timeout = 30 -- gi√¢y
        local startTime = tick()
        while not (LocalPlayer:FindFirstChild("leaderstats") and LocalPlayer.leaderstats:FindFirstChild("üíé Diamonds")) do
            if tick() - startTime > timeout then
                warn("Timeout ch·ªù leaderstats['üíé Diamonds']")
                return false
            end
            task.wait(0.5)
        end
        
        return true
    end)
    
    if not success or not result then
        warn("L·ªói khi ƒë·ª£i game s·∫µn s√†ng: " .. tostring(result))
        return false
    end
    
    return true
end

-- ƒê·ª£i game s·∫µn s√†ng
if not waitForGameReady() then
    warn("Game kh√¥ng s·∫µn s√†ng, k·∫øt th√∫c script")
    return
end

print("Game ƒë√£ s·∫µn s√†ng, b·∫Øt ƒë·∫ßu ch·∫°y script")

-- H√†m ki·ªÉm tra v·ªã tr√≠ hi·ªán t·∫°i
local function getCurrentLocation()
    local currentPlaceId = game.PlaceId
    
    if currentPlaceId == PLACE_IDS.MAIN_WORLD then
        return "MAIN_WORLD"
    elseif currentPlaceId == PLACE_IDS.PLAZA_WORLD then
        return "PLAZA_WORLD"
    elseif currentPlaceId == PLACE_IDS.TRADING_PLAZA_1 or currentPlaceId == PLACE_IDS.TRADING_PLAZA_2 then
        return "TRADING_PLAZA"
    else
        return "UNKNOWN_" .. tostring(currentPlaceId)
    end
end

-- H√†m teleport ƒë·∫øn Trading Plaza n√¢ng cao
local function teleportToTradingPlaza()
    local currentLocation = getCurrentLocation()
    print("V·ªã tr√≠ hi·ªán t·∫°i: " .. currentLocation)
    
    if currentLocation == "TRADING_PLAZA" then
        print("ƒê√£ ·ªü Trading Plaza, kh√¥ng c·∫ßn teleport")
        return true
    end
    
    print("ƒêang teleport ƒë·∫øn Trading Plaza...")
    
    -- Ph∆∞∆°ng ph√°p 1: S·ª≠ d·ª•ng Network.Invoke
    local success1 = pcall(function()
        Network.Invoke("Travel to Trading Plaza")
        print("ƒê√£ g·ªçi Travel to Trading Plaza")
        task.wait(5)
    end)
    
    -- Ki·ªÉm tra l·∫°i v·ªã tr√≠ sau ph∆∞∆°ng ph√°p 1
    if getCurrentLocation() == "TRADING_PLAZA" then
        print("Ph∆∞∆°ng ph√°p 1 th√†nh c√¥ng!")
        return true
    end
    
    -- Ph∆∞∆°ng ph√°p 2: T√¨m v√† s·ª≠ d·ª•ng c·ªïng Trading Plaza
    print("Ph∆∞∆°ng ph√°p 1 th·∫•t b·∫°i, th·ª≠ ph∆∞∆°ng ph√°p 2...")
    local success2 = pcall(function()
        -- T√¨m c·ªïng Trading Plaza trong khu v·ª±c Castle
        local ZonesUtil = require(ReplicatedStorage.Library.Util.ZonesUtil)
        local castleFolder = ZonesUtil.GetInteractFolder and ZonesUtil.GetInteractFolder("Castle")
        
        if castleFolder then
            local portal = castleFolder:FindFirstChild("TradingPlazaPortal")
            if portal and portal:FindFirstChild("InteractHolder") then
                -- Teleport ƒë·∫øn v·ªã tr√≠ c·ªïng
                local portalPos = portal.InteractHolder.Position
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                    LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(portalPos)
                    task.wait(1)
                    
                    -- T∆∞∆°ng t√°c v·ªõi c·ªïng
                    Network.Fire("Teleporting to Trading Plaza!")
                    Network.Invoke("Travel to Trading Plaza")
                    task.wait(3)
                end
            end
        end
    end)
    
    -- Ki·ªÉm tra l·∫°i v·ªã tr√≠ sau ph∆∞∆°ng ph√°p 2
    if getCurrentLocation() == "TRADING_PLAZA" then
        print("Ph∆∞∆°ng ph√°p 2 th√†nh c√¥ng!")
        return true
    end
    
    -- Ph∆∞∆°ng ph√°p 3: S·ª≠ d·ª•ng TeleportService tr·ª±c ti·∫øp
    print("Ph∆∞∆°ng ph√°p 2 th·∫•t b·∫°i, th·ª≠ ph∆∞∆°ng ph√°p 3...")
    local success3 = pcall(function()
        TeleportService:Teleport(PLACE_IDS.TRADING_PLAZA_1)
        task.wait(5)
    end)
    
    print("ƒê√£ th·ª≠ t·∫•t c·∫£ ph∆∞∆°ng ph√°p teleport")
    return (getCurrentLocation() == "TRADING_PLAZA")
end

-- H√†m t√≠nh RAP
local function GetRap(itemClass, itemData)
    local ok, result = pcall(function()
        -- kh·ªüi t·∫°o item object
        local itm = require(Library.Items[itemClass .. "Item"])(itemData.id)
        if itemData.sh then itm:SetShiny(true) end
        if itemData.pt == 1 then itm:SetGolden() end
        if itemData.pt == 2 then itm:SetRainbow() end
        return itm:GetRAP() or 0
    end)
    if not ok then
        warn("L·ªói GetRap:", result)
        return 0
    end
    return result
end

-- H√†m chi·∫øm gian h√†ng
local function occupyBooth()
    local success, result = pcall(function()
        -- Ki·ªÉm tra xem ƒë√£ c√≥ gian h√†ng ch∆∞a
        local HaveBooth = false
        for _, Booth in ipairs(workspace.__THINGS.Booths:GetChildren()) do
            if Booth:IsA("Model") and Booth:GetAttribute("Owner") == LocalPlayer.UserId then
                HaveBooth = true
                currentBooth = Booth
                LocalPlayer.Character.HumanoidRootPart.CFrame = Booth.Table.CFrame * CFrame.new(5, 0, 0)
                print("ƒê√£ t√¨m th·∫•y gian h√†ng c·ªßa b·∫°n!")
                return true
            end
        end

        if not HaveBooth then
            -- T√¨m gian h√†ng g·∫ßn nh·∫•t ƒë·ªÉ chi·∫øm
            local pos, id
            local distance = math.huge
            local playerPos = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and LocalPlayer.Character.HumanoidRootPart.Position
            if not playerPos then return false end

            for _, v in pairs(workspace.TradingPlaza.BoothSpawns:GetChildren()) do
                if v and v.WorldPivot then
                    local boothPosition = v.WorldPivot.Position
                    local currentDistance = (boothPosition - playerPos).Magnitude
                    local boothId = v:GetAttribute("ID")
                    if boothId and currentDistance < distance then
                        distance = currentDistance
                        pos = boothPosition
                        id = boothId
                    end
                end
            end

            if pos and id then
                LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(pos + Vector3.new(-5, 5, 0))
                task.wait(0.5)
                local claimSuccess = pcall(function()
                    Network.Invoke("Booths_ClaimBooth", tostring(id))
                end)
                if claimSuccess then
                    print("ƒê√£ chi·∫øm gian h√†ng ID: " .. id)
                    return true
                else
                    warn("Kh√¥ng th·ªÉ chi·∫øm gian h√†ng")
                    return false
                end
            else
                warn("Kh√¥ng t√¨m th·∫•y gian h√†ng g·∫ßn!")
                return false
            end
        end
    end)
    
    if not success then
        warn("L·ªói khi chi·∫øm gian h√†ng: " .. tostring(result))
        return false
    end
    
    return result
end

-- H√†m g·ª≠i kim c∆∞∆°ng
local function sendGems()
    local success, result = pcall(function()
        local targetUser = getgenv().Config["Account Hold Gem"]
        if targetUser == "" then
            warn("Ch∆∞a c·∫•u h√¨nh t√†i kho·∫£n nh·∫≠n kim c∆∞∆°ng")
            return false
        end
        
        local diamondThreshold = Functions.ParseNumberSmart(getgenv().Config["Gem"])
        local currentDiamonds = LocalPlayer.leaderstats["üíé Diamonds"].Value
        
        if currentDiamonds >= diamondThreshold then
            -- T√¨m ID c·ªßa kim c∆∞∆°ng
            for i, v in pairs(Savemod.Get().Inventory.Currency) do
                if v.id == "Diamonds" then
                    -- Gi·ªØ l·∫°i 1 t·ª∑ kim c∆∞∆°ng
                    local amountToSend = currentDiamonds - Functions.ParseNumberSmart("1b")
                    
                    -- G·ª≠i kim c∆∞∆°ng
                    local args = {
                        [1] = targetUser,
                        [2] = "T·ª± ƒë·ªông g·ª≠i t·ª´ script",
                        [3] = "Currency",
                        [4] = tostring(i),
                        [5] = amountToSend
                    }
                    
                    ReplicatedStorage.Network["Mailbox: Send"]:InvokeServer(unpack(args))
                    print("ƒê√£ g·ª≠i " .. tostring(amountToSend) .. " kim c∆∞∆°ng ƒë·∫øn " .. targetUser)
                    return true
                end
            end
            warn("Kh√¥ng t√¨m th·∫•y ID kim c∆∞∆°ng")
        end
        
        return false
    end)
    
    if not success then
        warn("L·ªói khi g·ª≠i kim c∆∞∆°ng: " .. tostring(result))
        return false
    end
    
    return result
end

-- H√†m ƒë·∫øm s·ªë slot ƒë√£ s·ª≠ d·ª•ng trong gian h√†ng
local function countUsedBoothSlots()
    local count = 0
    local success, result = pcall(function()
        if not currentBooth then return 0 end
        
        for _, child in pairs(currentBooth.Pets.BoothTop.PetScroll:GetChildren()) do
            if child:IsA("Frame") then
                count = count + 1
            end
        end
        
        return count
    end)
    
    if not success then
        warn("L·ªói khi ƒë·∫øm slot gian h√†ng: " .. tostring(result))
        return 0
    end
    
    return count
end

-- H√†m x√≥a t·∫•t c·∫£ listing
local function removeAllListings()
    local success, result = pcall(function()
        if not currentBooth then return false end
        
        for _, v1 in pairs(currentBooth.Pets.BoothTop.PetScroll:GetChildren()) do
            if v1:IsA("Frame") then
                ReplicatedStorage.Network["Booths_RemoveListing"]:InvokeServer(v1.Name)
                task.wait(0.2) -- Tr√°nh ratelimit
            end
        end
        
        -- Reset danh s√°ch ƒë√£ list v√† s·ªë slot ƒë√£ s·ª≠ d·ª•ng
        listedItems = {}
        usedSlots = 0
        print("ƒê√£ x√≥a t·∫•t c·∫£ listing")
        return true
    end)
    
    if not success then
        warn("L·ªói khi x√≥a listing: " .. tostring(result))
        return false
    end
    
    return result
end

-- H√†m x√°c ƒë·ªãnh lo·∫°i pet Huge
local function getHugeType(petId, petData)
    if petData.pt == 1 or string.find(petId, "Golden") then
        return "All Huges Golden"
    elseif petData.pt == 2 or string.find(petId, "Rainbow") then
        return "All Huges Rainbow"
    elseif petData.sh or string.find(petId, "Shiny") then
        return "All Huges Shiny"
    else
        return "All Huges Normal"
    end
end

-- H√†m t√≠nh gi√° d·ª±a tr√™n chi·∫øn l∆∞·ª£c
local function calculatePrice(rap, strategy)
    local multiplier = 1
    local desc = strategy

    if strategy == "market" then
        multiplier = 1
    elseif strategy == "auto" then
        local used = usedSlots / MAX_BOOTH_SLOTS
        if used > 0.8 then multiplier = 0.9
        elseif used > 0.5 then multiplier = 0.95
        end
    elseif type(strategy) == "string" then
        -- match "+10%" ho·∫∑c "-2%"
        local sign, pct = strategy:match("^([%+%-])([%d%.]+)%%$")
        pct = tonumber(pct)
        if sign == "+" then
            multiplier = 1 + pct/100
        elseif sign == "-" then
            multiplier = 1 - pct/100
        end
    elseif type(strategy) == "number" then
        multiplier = 1 + (strategy/100)
        desc = (strategy>=0 and "+"..strategy or tostring(strategy)).."%"
    end

    local price = math.floor(rap * multiplier)

    if getgenv().Config["Randomize Price"] then
        -- +/- range% th·ª±c ra: getgenv().Config["Random Range"]
        local r = getgenv().Config["Random Range"]/100
        price = math.floor(price * (1 + (math.random()*2 - 1)*r))
    end

    return price, desc
end

-- H√†m t·∫°o listing cho pet Huge
local function createHugeListing(uuid, petData)
    local rap = GetRap("Pet", petData)

    -- B·ªè qua n·∫øu RAP d∆∞·ªõi ng∆∞·ª°ng
    local minRap = getgenv().Config["Minimum Price"] or 0
    if rap < minRap then
        if getgenv().Config["Debug Mode"] then
            print(("B·ªè qua %s v√¨ RAP (%d) < Minimum Price (%d)"):format(petData.id, rap, minRap))
        end
        return false
    end

    -- Ki·ªÉm tra blacklist
    for _, blacklistedPet in ipairs(getgenv().hugeBlacklist or {}) do
        if string.find(petData.id, blacklistedPet) then
            if getgenv().Config["Debug Mode"] then
                print("B·ªè qua pet: " .. petData.id .. " (trong blacklist)")
            end
            return false
        end
    end
    
    -- L·∫•y c·∫•u h√¨nh pet
    local typeString = getHugeType(petData.id, petData)
    local hugeConfig = getgenv().hugemode[typeString]
    
    -- Ki·ªÉm tra xem c√≥ c·∫•u h√¨nh h·ª£p l·ªá kh√¥ng
    if not hugeConfig or not hugeConfig.sell then 
        return false 
    end
    
    -- Ki·ªÉm tra c·∫•u h√¨nh t√πy ch·ªânh cho pet c·ª• th·ªÉ
    for specificPet, customConfig in pairs(getgenv().customPetPricing or {}) do
        if string.find(petData.id, specificPet) then
            -- Ghi ƒë√® chi·∫øn l∆∞·ª£c n·∫øu c√≥
            if customConfig.strategy then
                hugeConfig.strategy = customConfig.strategy
            end
            -- Ghi ƒë√® gi√° t·ªëi thi·ªÉu n·∫øu c√≥
            if customConfig.min_price then
                hugeConfig.min_price = customConfig.min_price
            end
            -- Ghi ƒë√® gi√° t·ªëi ƒëa n·∫øu c√≥
            if customConfig.max_price then
                hugeConfig.max_price = customConfig.max_price
            end
            
            if getgenv().Config["Debug Mode"] then
                print("√Åp d·ª•ng c·∫•u h√¨nh t√πy ch·ªânh cho pet: " .. petData.id)
            end
            break
        end
    end
    
    -- T√≠nh gi√° d·ª±a tr√™n chi·∫øn l∆∞·ª£c
    local calculatedPrice, strategyDescription = calculatePrice(rap, hugeConfig.strategy)
    
    -- √Åp d·ª•ng gi·ªõi h·∫°n gi√°
    local minPrice = hugeConfig.min_price or getgenv().Config["Minimum Price"] or 0
    local maxPrice = hugeConfig.max_price or getgenv().Config["Maximum Price"] or math.huge
    
    local finalPrice = math.max(minPrice, math.min(maxPrice, calculatedPrice))
    
    -- Debug th√¥ng tin t√≠nh gi√°
    debugPrice(petData.id, rap, calculatedPrice, strategyDescription, finalPrice)
    
    if finalPrice <= 0 then
        warn("Gi√° kh√¥ng h·ª£p l·ªá cho " .. petData.id)
        return false
    end
    
    local maxAmount = math.min(petData._am or 1, 15000, math.floor(25e9 / finalPrice))
    if maxAmount <= 0 then
        warn("S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá cho " .. petData.id)
        return false
    end
    
    print("ƒêang th·ª≠ b√°n " .. petData.id .. " v·ªõi gi√° " .. finalPrice .. " (" .. strategyDescription .. " c·ªßa RAP " .. rap .. ")")
    
    local success, err = pcall(function()
        return Network.Invoke("Booths_CreateListing", uuid, math.ceil(finalPrice), maxAmount)
    end)
    
    if success then
        listedItems[uuid] = true
        usedSlots = usedSlots + 1
        hugesSold = hugesSold + 1
        print("‚úÖ ƒê√É B√ÅN PET HUGE TH√ÄNH C√îNG: " .. petData.id .. " v·ªõi gi√° " .. finalPrice .. " (Slot " .. usedSlots .. "/" .. MAX_BOOTH_SLOTS .. ")")
        return true
    else
        warn("‚ùå KH√îNG TH·ªÇ B√ÅN PET: " .. tostring(err))
        return false
    end
end

-- H√†m t·∫°o listing cho v·∫≠t ph·∫©m
local function createItemListing(uuid, itemId, itemClass, amount, rap)
    -- Ki·ªÉm tra xem ƒë√£ list item n√†y ch∆∞a
    if listedItems[uuid] then return false end
    
    -- Ki·ªÉm tra xem c√≤n slot tr·ªëng kh√¥ng
    if usedSlots >= MAX_BOOTH_SLOTS then
        print("ƒê√£ ƒë·∫°t gi·ªõi h·∫°n " .. MAX_BOOTH_SLOTS .. " slot gian h√†ng")
        return false
    end
    
    local price = 0
    -- Ki·ªÉm tra xem c√≥ c·∫•u h√¨nh cho item n√†y kh√¥ng
    if getgenv().item[itemId] then
        price = math.floor(rap * (getgenv().item[itemId] / 100))
    else
        return false
    end
    
    if price <= 0 then
        warn("Gi√° kh√¥ng h·ª£p l·ªá cho " .. itemId)
        return false
    end
    
    local listingAmount = math.min(amount, 15000, math.floor(25e9 / price))
    if listingAmount <= 0 then
        warn("S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá cho " .. itemId)
        return false
    end
    
    local args = {
        [1] = tostring(uuid),
        [2] = price,
        [3] = listingAmount
    }
    
    local success, err = pcall(function()
        return Network.Invoke("Booths_CreateListing", unpack(args))
    end)
    
    if success then
        listedItems[uuid] = true
        usedSlots = usedSlots + 1
        normalItemsSold = normalItemsSold + 1
        print("ƒê√£ t·∫°o listing cho v·∫≠t ph·∫©m: " .. itemId .. " v·ªõi gi√° " .. price .. " (Slot " .. usedSlots .. "/" .. MAX_BOOTH_SLOTS .. ")")
        return true
    else
        warn("L·ªói khi t·∫°o listing cho v·∫≠t ph·∫©m: " .. tostring(err))
        return false
    end
end

-- H√†m so s√°nh ∆∞u ti√™n cho pet Huge
local function compareHugePriority(pet1, pet2)
    -- N·∫øu Config["Prioritize Low RAP"] ƒë∆∞·ª£c b·∫≠t, ∆∞u ti√™n pet c√≥ RAP th·∫•p
    if getgenv().Config["Prioritize Low RAP"] then
        return pet1.Rap < pet2.Rap
    end
    
    -- N·∫øu c·∫£ hai pet ƒë·ªÅu trong danh s√°ch ∆∞u ti√™n
    local pet1Priority, pet2Priority = 999, 999
    
    for i, priorityPet in ipairs(getgenv().hugePriority or {}) do
        if string.find(pet1.Item.id, priorityPet) then
            pet1Priority = i
        end
        
        if string.find(pet2.Item.id, priorityPet) then
            pet2Priority = i
        end
    end
    
    -- N·∫øu ch·ªâ pet 1 ho·∫∑c pet 2 n·∫±m trong danh s√°ch ∆∞u ti√™n
    if pet1Priority ~= pet2Priority then
        return pet1Priority < pet2Priority
    end
    
    -- M·∫∑c ƒë·ªãnh s·∫Øp x·∫øp theo RAP gi·∫£m d·∫ßn
    return pet1.Rap > pet2.Rap
end

-- Logic teleport v√† chi·∫øm gian h√†ng (ƒë√£ c·∫£i ti·∫øn)
spawn(function()
    while task.wait(5) do
        local currentLocation = getCurrentLocation()
        print("V·ªã tr√≠ hi·ªán t·∫°i: " .. currentLocation)
        
        -- N·∫øu kh√¥ng ·ªü Trading Plaza, teleport ƒë·∫øn ƒë√≥
        if currentLocation ~= "TRADING_PLAZA" then
            print("Kh√¥ng ·ªü Trading Plaza, ƒëang teleport...")
            teleportToTradingPlaza()
        else
            -- ƒê·ª£i nh√¢n v·∫≠t load
            if not (LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")) then
                task.wait(1)
                continue
            end
            
            -- Chi·∫øm gian h√†ng
            if not currentBooth then
                print("ƒêang th·ª≠ chi·∫øm gian h√†ng...")
                occupyBooth()
            end
        end
    end
end)

-- G·ª≠i kim c∆∞∆°ng
spawn(function()
    while task.wait(30) do
        local targetUser = getgenv().Config["Account Hold Gem"]
        -- Ch·ªâ g·ª≠i n·∫øu ƒë√£ c·∫•u h√¨nh
        if targetUser and targetUser ~= "" then
            sendGems()
        else
            -- Th√¥ng b√°o m·ªôt l·∫ßn
            print("ƒê√£ b·ªè qua g·ª≠i kim c∆∞∆°ng do ch∆∞a c·∫•u h√¨nh")
            break -- Tho√°t kh·ªèi v√≤ng l·∫∑p n·∫øu kh√¥ng c·∫•u h√¨nh
        end
    end
end)

-- X√≥a listing ƒë·ªãnh k·ª≥
spawn(function()
    while true do
        task.wait(getgenv().Config["Time Remove"] * 60)
        if getCurrentLocation() == "TRADING_PLAZA" then
            removeAllListings()
        end
    end
end)

-- Server hopping
spawn(function()
    while true do
        task.wait(getgenv().Config["Hop sever"] * 60)
        
        -- Ki·ªÉm tra xem c√≥ ƒë·ªß th·ªùi gian ƒë·ªÉ hop server kh√¥ng
        print("Hopping server...")
        if getCurrentLocation() == "TRADING_PLAZA" then
            local servers = {}
            local cursor = ""
            local req = HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100" .. cursor))
            
            for _, server in ipairs(req.data) do
                if server.playing < server.maxPlayers and server.id ~= game.JobId then
                    table.insert(servers, server.id)
                end
            end
            
            if #servers > 0 then
                local randomServer = servers[math.random(1, #servers)]
                TeleportService:TeleportToPlaceInstance(game.PlaceId, randomServer)
            else
                print("Kh√¥ng t√¨m th·∫•y server ƒë·ªÉ hop")
            end
        end
    end
end)

-- Th√™m th√¥ng tin th·ªëng k√™ ƒë·ªãnh k·ª≥
spawn(function()
    while true do
        task.wait(60) -- M·ªói ph√∫t hi·ªÉn th·ªã th·ªëng k√™ m·ªôt l·∫ßn
        
        print("===== TH·ªêNG K√ä SCRIPT =====")
        print("Th·ªùi gian ch·∫°y: " .. getElapsedTimeString())
        print("T·ªïng s·ªë pet Huge trong kho: " .. totalhuge)
        print("S·ªë pet Huge ƒë√£ listing: " .. hugesSold)
        print("S·ªë v·∫≠t ph·∫©m th∆∞·ªùng ƒë√£ listing: " .. normalItemsSold)
        print("Slot s·ª≠ d·ª•ng: " .. usedSlots .. "/" .. MAX_BOOTH_SLOTS)
        print("============================")
    end
end)

-- Main loop - T·∫°o listings
spawn(function()
    while true do
        task.wait(10)
        
        if getCurrentLocation() ~= "TRADING_PLAZA" then
            continue
        end
        
        -- Ki·ªÉm tra xem c√≥ gian h√†ng kh√¥ng
        if not currentBooth then
            occupyBooth()
            if not currentBooth then
                print("Kh√¥ng t√¨m th·∫•y gian h√†ng, ƒëang th·ª≠ l·∫°i...")
                continue
            end
        end
        
        -- C·∫≠p nh·∫≠t s·ªë slot ƒë√£ s·ª≠ d·ª•ng
        usedSlots = countUsedBoothSlots()
        print("Hi·ªán t·∫°i ƒëang s·ª≠ d·ª•ng: " .. usedSlots .. "/" .. MAX_BOOTH_SLOTS .. " slot gian h√†ng")
        
        -- Ki·ªÉm tra xem ƒë√£ ƒë·∫ßy slot ch∆∞a
        if usedSlots >= MAX_BOOTH_SLOTS then
            print("ƒê√£ s·ª≠ d·ª•ng ƒë·ªß " .. MAX_BOOTH_SLOTS .. " slot gian h√†ng, ch·ªù ƒë·∫øn l·∫ßn reset")
            task.wait(60) -- ƒê·ª£i 1 ph√∫t tr∆∞·ªõc khi ki·ªÉm tra l·∫°i
            continue
        end
        
        -- T·∫°o danh s√°ch v·∫≠t ph·∫©m ƒë·ªÉ list
        local BoothQueue = {}
        
        -- Th√™m v·∫≠t ph·∫©m th∆∞·ªùng v√†o h√†ng ƒë·ª£i
        for Class, Items in pairs(Savemod.Get().Inventory) do
            if Class == "Pet" then continue end -- X·ª≠ l√Ω pet ri√™ng
            
            for ItemId, ItemData in pairs(Items) do
                local amount = ItemData._am or 1
                if getgenv().item[ItemData.id] and not listedItems[ItemId] and amount > 0 then
                    local rap = GetRap(Class, ItemData)
                    if rap > 0 then
                        table.insert(BoothQueue, {
                            UUID = ItemId,
                            Item = ItemData,
                            Class = Class,
                            Rap = rap,
                            Type = "Normal"
                        })
                    end
                end
            end
        end
        
        -- Th√™m pet "Huge" v√†o h√†ng ƒë·ª£i
        for PetId, PetData in pairs(Savemod.Get().Inventory.Pet) do
            if string.find(PetData.id, "Huge") and not listedItems[PetId] then
                local rap = GetRap("Pet", PetData)
                
                if rap > 0 then
                    local typeString = getHugeType(PetData.id, PetData)
                    table.insert(BoothQueue, {
                        UUID = PetId,
                        Item = PetData,
                        Class = "Pet",
                        Rap = rap,
                        Type = "Huge",
                        HugeType = typeString
                    })
                end
            end
        end
        
        -- S·∫Øp x·∫øp theo th·ª© t·ª± ∆∞u ti√™n t√πy ch·ªânh
        table.sort(BoothQueue, compareHugePriority)
        
        -- T√≠nh to√°n s·ªë l∆∞·ª£ng slot c√≤n tr·ªëng
        local remainingSlots = MAX_BOOTH_SLOTS - usedSlots
        print("C√≥ th·ªÉ th√™m t·ªëi ƒëa " .. remainingSlots .. " v·∫≠t ph·∫©m v√†o gian h√†ng")
        
        -- Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng v·∫≠t ph·∫©m s·∫Ω ƒë∆∞·ª£c th√™m v√†o
        local itemsToAdd = math.min(remainingSlots, #BoothQueue)
        if itemsToAdd == 0 then
            print("Kh√¥ng c√≥ v·∫≠t ph·∫©m m·ªõi ƒë·ªÉ th√™m v√†o gian h√†ng")
            task.wait(60) -- ƒê·ª£i 1 ph√∫t tr∆∞·ªõc khi ki·ªÉm tra l·∫°i
            continue
        end
        
        print("ƒêang th√™m " .. itemsToAdd .. " v·∫≠t ph·∫©m v√†o gian h√†ng...")
        
        -- ƒê·∫∑t th·ªùi gian ch·ªù gi·ªØa c√°c l·∫ßn listing
        local waitTimeBetweenListings = 1
        
        -- T·∫°o listing theo th·ª© t·ª± ∆∞u ti√™n, ch·ªâ cho ƒë·∫øn khi ƒë·∫ßy slot
        for i = 1, itemsToAdd do
            local ItemInfo = BoothQueue[i]
            
            -- D·ª´ng n·∫øu ƒë√£ ƒë·∫ßy slot
            if usedSlots >= MAX_BOOTH_SLOTS then
                print("ƒê√£ s·ª≠ d·ª•ng ƒë·ªß " .. MAX_BOOTH_SLOTS .. " slot gian h√†ng")
                break
            end
            
            if ItemInfo.Type == "Huge" then
                createHugeListing(ItemInfo.UUID, ItemInfo.Item)
            else
                createItemListing(ItemInfo.UUID, ItemInfo.Item.id, ItemInfo.Class, ItemInfo.Item._am or 1, ItemInfo.Rap)
            end
            task.wait(waitTimeBetweenListings) -- ƒê·ª£i gi·ªØa c√°c listing ƒë·ªÉ tr√°nh rate limit
        end
    end
end)

-- In th√¥ng tin v·ªã tr√≠ kh·ªüi ƒë·ªông
print("V·ªã tr√≠ khi kh·ªüi ƒë·ªông: " .. getCurrentLocation())
print("Script ƒë√£ kh·ªüi ƒë·ªông th√†nh c√¥ng v·ªõi icon Trading Plaza: " .. TRADING_PLAZA_ICON)
print("ƒê√£ c·∫•u h√¨nh ∆∞u ti√™n b√°n pet Huge theo RAP t·ª´ th·∫•p ƒë·∫øn cao")
